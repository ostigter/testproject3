Design
======


Java interface
--------------

interface Database {
    void start() throws XmldbException
    void shutdown() throws XmldbException
    boolean isRunning()
    Collection getRootCollection() throws XmldbException
    Set<Document> findDocuments(Key[] keys)                          // Move to Collection
}

public class Collection {
    String getName()
    Date getCreated()
    Date getModified()
    Set<Collection> getCollections()
    Collection getCollection(String name)
    Set<Document> getDocuments()
    Document getDocument(String name)
    Set<Document> findDocuments(Key[] keys)
    Collection createCollection(String name) throws XmldbException
    Document createDocument(String name) throws XmldbException
    void delete(boolean recursive) throws XmldbException
}

public class Document {
    String getName()
    void setName(String name) throws XmldbException
    Date getCreated()
    Date getModified()
    long getSize()
    InputStream getContent() throws XmldbException
    OutputStream setContent() throws XmldbException
    Set<Key> getKeys()
    Object getKey(String name)
    void setKeys(Keys[] keys)
    void setKey(String name, Object value)
    void move(Collection col) throws XmldbException
    void copy(Collection col) throws XmldbException
    void copy(Collection col, String name) throws XmldbException
    void delete() throws XmldbException
}

public class Key {
    String getName()
    void setName(String name)
    Object getValue()
    void setValue(Object value)
}

public class XmldbException {
    XmldbException(String msg)
    XmldbException(String msg, Throwable t)
}



Storage
-------

metadata.dbx
------------

<nextId> (4 bytes)


collections.dbx
---------------

Example:

db/ (ID 1)
  data/ (ID 2)
    doc_0001.xml (ID 3)
    doc_0002.xml (ID 4)
  modules/ (ID 5)
    main.xqy (ID 6)
    util.xqy (ID 7)

1                       # col ID
"db"                    # col name
-1                      # parent ID
0                       # doc count
2                       # col count
  2                     # col ID
  "data"                # name
  1                     # parent ID
  2                     # doc count
    3                   # doc ID
    "doc_0001.xml"      # doc name
    4                   # doc ID
    "doc_0002.xml"      # doc name
  0                     # col count
  5                     # col ID
  "modules"             # col name
  1                     # parent ID
  2                     # doc count
    6                   # doc ID
    "main.xqy"          # doc name
    7                   # doc ID
    "util.xqy"          # doc name
  0                     # col count


indices.dbx
-----------

Index (XML):
  Name
  Path (element or attribute)
  Type (string, integer, date)

Examples:
  {"DocumentId",   "/Header/Document/Id", Index.STRING)
  ("DocumentType", "/Header/Document/@type", Index.STRING)
  ("OrderNr",      "/Body/Order/Number"